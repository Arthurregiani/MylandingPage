<action>
<suggest_plan>
<plan>
<steps>
<step>
<title>
Visão geral e objetivos
</title>
<details>
Arquitetura alvo:
- Next.js servindo a landing page, empacotado em Docker e exposto publicamente via Cloudflare Tunnel
- Nenhuma porta pública aberta no roteador ou no servidor para HTTP/HTTPS
- Site oficial em https://www.tutsdev.com.br (www) e redirecionamento do apex tutsdev.com.br para www no edge do Cloudflare
- Formulário de contato funcional com SMTP do Gmail usando App Password
- Opcional: SSH via Cloudflare Access, sem expor a porta 22 publicamente

Entradas e preferências confirmadas:
- Domínio: tutsdev.com.br registrado no Registro.br, ainda não adicionado ao Cloudflare
- Hostname do site: www.tutsdev.com.br como principal; apex redirecionando para www
- Deploy: Docker e docker compose
- Servidor: Ubuntu Server em rede local; usuário de deploy tutu com sudo
- Código: repositório público, será clonado no servidor
- SMTP: Gmail com App Password
- SSH via Cloudflare Access: desejado entendimento e opcionalmente habilitar

Resultados esperados ao final:
- www.tutsdev.com.br online via Cloudflare Tunnel
- tutsdev.com.br redirecionando 301 para https://www.tutsdev.com.br
- Contato envia e-mail com Gmail SMTP
- Opcional: SSH acessível via ssh.tutsdev.com.br sem exposição pública da porta 22
</details>
</step>
<step>
<title>
Colocar o domínio tutsdev.com.br no Cloudflare e apontar nameservers no Registro.br
</title>
<details>
No Cloudflare:
1) Acesse dash.cloudflare.com e clique em Add a site
2) Informe tutsdev.com.br e selecione o plano Free
3) Ao final, o Cloudflare exibirá dois nameservers atribuídos ao seu domínio (exemplo: alice.ns.cloudflare.com e bob.ns.cloudflare.com). Anote exatamente os dois nomes fornecidos para sua zona

No Registro.br:
1) Acesse registro.br e faça login
2) Vá em Domínios, clique em tutsdev.com.br e depois em Alterar servidores DNS
3) Selecione usar servidores DNS de outro provedor e informe os dois nameservers do Cloudflare exatamente como exibidos
4) Salve a alteração

Validação:
- Retorne ao Cloudflare e aguarde o status do domínio ficar Active (alguns minutos até poucas horas)
</details>
</step>
<step>
<title>
Configurações iniciais na zona do Cloudflare: SSL, HTTPS e redirecionamento do apex para www
</title>
<details>
1) SSL/TLS
- Em Overview: Encryption mode em Full
- Em Edge Certificates: ative Always Use HTTPS e Automatic HTTPS Rewrites; Minimum TLS Version 1.2

2) DNS do apex para permitir redirecionamento no edge:
- Em DNS, adicione A @ apontando para 192.0.2.1 com Proxy ativado (nuvem laranja). Este IP é fictício, apenas para o Cloudflare receber a requisição e aplicar o redirect

3) Redirect Rule do apex para www (301):
- Em Rules, Redirect Rules, Create rule, Single Redirect
- Expression: http.host eq "tutsdev.com.br"
- Destination URL: https://www.tutsdev.com.br
- Status code: 301
- Salve e publique
</details>
</step>
<step>
<title>
Criar o Cloudflare Tunnel e os hostnames públicos para www e SSH opcional
</title>
<details>
No Cloudflare Zero Trust:
1) Zero Trust no menu lateral, depois Networks e Tunnels
2) Create a tunnel, escolha Cloudflared, nomeie (ex.: tutsdev-www) e salve
3) Na etapa de instalação, selecione Docker e copie o valor do token mostrado (TUNNEL_TOKEN) para uso no docker compose

Public Hostnames do túnel:
- Adicione hostname www.tutsdev.com.br com Service HTTP apontando para http://landing:3000
- Opcional: adicione hostname ssh.tutsdev.com.br com Service SSH apontando para ssh://host.docker.internal:22
- Salve. O Cloudflare criará o DNS de www como CNAME para o domínio cfargotunnel.com (proxied)

Observações:
- Usaremos o nome do serviço Docker landing para o backend HTTP
- Para o SSH via túnel, usaremos host.docker.internal com host-gateway no Docker para alcançar a porta 22 do host sem exposição pública
</details>
</step>
<step>
<title>
Preparar o Ubuntu Server: Docker, Compose, firewall e diretórios
</title>
<details>
1) Atualizar e instalar pacotes base (executar com sudo):
- apt update e apt upgrade
- apt install ca-certificates curl gnupg git ufw

2) Instalar Docker Engine e Compose plugin (repositório oficial da Docker):
- Adicionar chave e repo da Docker, apt update, instalar docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

3) Usuário e grupos:
- Adicionar o usuário tutu ao grupo docker e reabrir a sessão (newgrp docker)

4) Firewall UFW (sem portas públicas):
- Padrão deny incoming e allow outgoing
- Permitir SSH somente da sua LAN, por exemplo 192.168.0.0/16 para porta 22
- Habilitar UFW e verificar status

5) Diretrizes de diretórios:
- Criar /opt/tutsdev/landing e conceder propriedade ao usuário tutu
</details>
</step>
<step>
<title>
Clonar o código da landing page no servidor
</title>
<details>
1) Em /opt/tutsdev/landing, execute git clone do repositório público para a pasta atual
2) Garanta que o projeto builda localmente com npm run build
3) Caso ainda não exista, habilite output standalone no Next para uma imagem Docker enxuta
</details>
</step>
<step>
<title>
Dockerizar a aplicação Next.js com output standalone
</title>
<details>
1) next.config.js com output standalone e reactStrictMode ligado
2) Dockerfile multi-stage com Node 20 Alpine, executando node server.js a partir do artefato standalone
3) .dockerignore ignorando node_modules, .next, .env*, etc
4) Assegurar que nodemailer está em dependencies no package.json
</details>
</step>
<step>
<title>
docker-compose com serviços landing e tunnel
</title>
<details>
1) Usar dois arquivos de ambiente:
- .env para variáveis do compose (CLOUDFLARE_TUNNEL_TOKEN)
- .env.production para a aplicação (SMTP e afins)

2) Conteúdo do docker-compose.yml:
- Serviço landing: build Dockerfile, env_file .env.production, expose 3000, healthcheck, rede web
- Serviço tunnel: imagem cloudflare/cloudflared, comando tunnel run com token, extra_hosts com host-gateway, depends_on landing saudável, rede web

3) Criar .env com a variável CLOUDFLARE_TUNNEL_TOKEN preenchida com o token do painel do Cloudflare
</details>
</step>
<step>
<title>
Configurar SMTP do Gmail com App Password
</title>
<details>
1) No Gmail: habilitar verificação em duas etapas e gerar App Password
2) Definir em .env.production:
- SMTP_HOST=smtp.gmail.com
- SMTP_PORT=465
- SMTP_SECURE=true
- SMTP_USER=seu_email@gmail.com
- SMTP_PASS=senha_app_16_caracteres
- MAIL_FROM=TutsDev Contato via Gmail
- CONTACT_EMAIL_TO=destinatario@tutsdev.com.br

Boas práticas:
- Usar o mesmo remetente de SMTP_USER para melhor entregabilidade
- Não versionar .env.production
</details>
</step>
<step>
<title>
Implementar ou validar o endpoint de contato e o modelo de requisição
</title>
<details>
1) Se usar App Router: app/api/contact/route.ts com POST lendo Name, Email, Message e enviando via nodemailer usando process.env SMTP_*
2) Se usar Pages Router: pages/api/contact.ts com a mesma lógica
3) Modelo do frontend em CamelCase:
- ContactFormRequest com campos Name, Email e Message (strings)
4) Recomendado adicionar Cloudflare Turnstile para proteção anti-bot
</details>
</step>
<step>
<title>
Subir os containers e validar o túnel e o domínio
</title>
<details>
1) Em /opt/tutsdev/landing, conferir Dockerfile, docker-compose.yml, .env e .env.production
2) Executar docker compose build, depois docker compose up -d
3) Verificar logs de landing e cf-tunnel
4) No Cloudflare Zero Trust, túnel deve estar Connected
5) Acessar https://www.tutsdev.com.br e validar
6) Acessar http://tutsdev.com.br e validar redirect 301 para https://www.tutsdev.com.br
7) Testar o formulário e confirmar recebimento no Gmail
</details>
</step>
<step>
<title>
Documentação de painel: DNS e hostnames após o túnel
</title>
<details>
1) Em DNS: www deve estar como CNAME para o domínio do túnel com Proxy ativo; apex @ como A 192.0.2.1 com Proxy ativo
2) Em Zero Trust Tunnels: confirmar Public Hostname www.tutsdev.com.br para http://landing:3000
3) Rules: Redirect rule do apex publicada e ativa
</details>
</step>
<step>
<title>
Opcional: SSH via Cloudflare Access sem expor a porta 22
</title>
<details>
1) Zero Trust Access Applications: criar Self-hosted app para ssh.tutsdev.com.br, política Allow para seu e-mail e autenticação por One-time PIN ou IdP
2) No túnel: adicionar Public Hostname ssh.tutsdev.com.br com Service ssh://host.docker.internal:22
3) No cliente: instalar cloudflared e configurar SSH usando ProxyCommand com cloudflared access ssh --hostname ssh.tutsdev.com.br
4) No servidor: opcionalmente negar 22 no UFW e não expor NAT no roteador

Resumo do funcionamento: cloudflared no servidor mantém conexão de saída ao Cloudflare; o acesso SSH passa pela identidade do Zero Trust e chega ao SSH local sem exposição pública
</details>
</step>
<step>
<title>
Operação: logs, monitoração e atualizações
</title>
<details>
1) Logs: docker compose logs -f landing e docker compose logs -f cf-tunnel
2) Status: docker compose ps
3) Atualização: git pull e docker compose up -d --build
4) Reset: docker compose down e depois up -d --build
5) Manter dependências atualizadas e builds reproduzíveis
</details>
</step>
<step>
<title>
Checklist final de produção
</title>
<details>
- Nameservers ativos no Cloudflare para tutsdev.com.br
- Redirect do apex para https://www.tutsdev.com.br ativo e em 301
- www servido via Cloudflare Tunnel e aplicação saudável
- Porta 22 não exposta publicamente; SSH opcional via Access funcionando
- Formulário de contato funcionando com Gmail e App Password
- Backups de docker-compose.yml, .env e .env.production guardados com segurança
</details>
</step>
</steps>
</plan>
<summary>
Provisionar a landing page Next.js no Ubuntu com Docker e Cloudflare Tunnel usando www.tutsdev.com.br, redirecionar o apex para www, configurar SMTP do Gmail e, opcionalmente, habilitar SSH via Cloudflare Access, tudo sem abrir portas públicas.
</summary>
</suggest_plan>
</action>
